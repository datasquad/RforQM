---
title: "Introduction to Data Handling and Statistics 2"
author: "Ralf Becker"
date: "29 November 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Preparing your workfile

We add the basic libraries needed for this week's work: 

```{r, message=FALSE, warning = FALSE}
library(tidyverse)    # for almost all data handling tasks
library(readxl)       # to import Excel data
library(ggplot2)      # to produce nice graphiscs
library(stargazer)    # to produce nice results tables
```


# Introduction

The example we are using here is taken from the CORE - Doing Economics resource. In particular we are using Project 8 which deals with international data on well-being. The data represent several waves of data from the European Value Study (EVS). A wave means that the same surevey is repeated at regular intervals (waves).


# Aim of this lesson

In this lesson we will revise some hypothesis testing and basic (simple) regression analysis. 


# Importing Data

The data have been prepared as demonstrated in the Doing Economics Project 8, up to and including Walk-Through 8.3. Please have a look at this to understand the amount of data work required before an empirical analysis can begin. The datafile is saved as an R data structure (wb_data.Rdata).

```{r}
#wb_data <- readRDS("wellbeing_data.RDS")   # load RDS file
load("WBdata.Rdata")
str(wb_data)  # prints some basic info on variables
```

Checking your environment you will see two objects. Along the proper datafile (`wb_data`) you will find `wb_data_Des` which contains some information for each of the variables. It will help us to navigate the obscure variable names.

```{r}
wb_data_Des
```

As you can see there are a number of interesting questions in this dataset. These questions will allow us to investigate whether attitudes to work differ between coountries and whether such differences correlate to different levels of self-reported happiness/life satisfaction.

# Some initial data analysis and summary statistics

Let us investigate some of the features of this dataset. It has `r nrow(wb_data)` observations and `r length(wb_data)` variables. Let's see which countries are represented in our dataset.

```{r}
unique(wb_data$S003)   # unque finds all the different values in a variable
```

As you can see these are 48 countries, almost all European, Canada and the U.S. being the exceptions. In the same manner we can find out how many waves of data we have available.


```{r}
unique(wb_data$S002EVS)
```

Let's find out how many observations/respondents we have for each country in each year. To do this we will resort to the powerful piping technique delievered through the functionality of the `tidyverse`

```{r}
table1 <- wb_data %>% group_by(S002EVS,S003) %>% # groups by Wave and Country
            summarise(n = n()) %>%               # summarises each group by calculating obs
            spread(S002EVS,n) %>%                # put Waves across columns
            print(n=Inf)                         # n = Inf makes sure that all rows are printed

```

You can see that the number of countries have increased through time, although Canada and the U.S. have dropped out. 

If you look at the dataframe itself (either `view(wb_data)` or double click on the little spreadsheet icon on the right hand edge of the Environment window) you will recognise that there are a lot of missing observations (codes as `NA`). Ordinarily we would be interested in finding out how many effective observations we have for the life satisfaction variable (`A170`). However, the initial datawork in [https://www.core-econ.org/doing-economics/book/text/08-03.html#part-81-cleaning-and-summarizing-the-data](Project 8 of Doing Economics, Walk-Through 8.2), has made sure that all the observations you can see are those with available data for this variable.

Let's look at a couple of graphical representations of our data. For instance we may be interested in figuring out whether life satisfaction (1 (dissatisfied) to 10 (satisfied)) and self-reported health are related to each other. We shall look at this on the basis of data aggregated for country-waves.

```{r}
table2 <- wb_data %>% group_by(S002EVS,S003) %>% # groups by Wave and Country
            summarise(Avg_LifeSatis = mean(A170),Avg_Health = mean(A009))     # summarises each group by calculating obs
            
ggplot(table2,aes(Avg_Health,Avg_LifeSatis, colour=S002EVS)) +
  geom_point() +
  ggtitle("Health v Life Satisfaction")
```
We can see a clear positive relation between the two variables.

Let's see whether we can see a similarly clear relationship between life satisfaction and respondent's attitude towards work (`C041` - "Work should come first even if it means less spare time, 1 = Strongly Agree, 5 = Strongly Disagree"). What would you expect to see?

```{r}
table2 <- wb_data %>% group_by(S002EVS,S003) %>% # groups by Wave and Country
            summarise(Avg_LifeSatis = mean(A170),Avg_WorkFirst = mean(C041))    # summarises each group by calculating obs

ggplot(table2,aes( Avg_WorkFirst, Avg_LifeSatis,colour=S002EVS)) +
  geom_point() +
  ggtitle("Work First v Life Satisfaction")
```

The relationship is less clear. Recall that small values for the "Work First" questions relate t othe countries where,m on average, respondents agreed more strongly with the statement!

```{r}
table3 <- wb_data %>% filter(S002EVS == "2008-2010") %>% 
            group_by(S003) %>% # groups by Country
            summarise(cor_LS_WF = cor(A170,C041,use = "pairwise.complete.obs"),
                      med_income = median(X047D)) %>%    # correlation, remove missing data
            arrange(cor_LS_WF) 

ggplot(table3,aes( cor_LS_WF, med_income)) +
  geom_point() +
  ggtitle("Corr(Life Satisfaction, Work First) v Median Income")

```

# Hypothesis testing

Let's investigate whether there are differences in some of the responses between countries. But before we do so we need to revisit some basic hypothesis testing. At the core is the understanding that there is some underlying population statistic (for instance the difference between the average life satisfaction in the Great Britain and Germany), but all we observe is a sample statistics (the difference between the sample average of life satisfaction in the Great Britain and Germany). What hypothesis testing does is that it uses the sample information to help us judge on some hypothesis regarding the true underlying (unknown!) population statistic (for instance that the average life satisfaction in Germany and the U.K. are equal).

Let's create a sample statistic:

```{r}
test_data_G <- wb_data %>% 
  filter(S003 == "Germany") %>%     # pick German data
  filter(S002EVS == "2008-2010")    # pick latest wave

mean_G <- mean(test_data_G$A170)

test_data_GB <- wb_data %>% 
  filter(S003 == "Great Britain") %>%  # pick British data
  filter(S002EVS == "2008-2010")       # pick latest wave

mean_GB <- mean(test_data_GB$A170)

sample_diff <- mean_G - mean_GB
  
```

So we can see that the sample difference is `rsample_diff`, hence the average German response to the question on Life Satisfaction is 0.76 lower than that in Great Britain. There is the proof, Germans are just miserable. Or is it? If we had asked a different set of individuals we would have received a different statistic. Is this difference perhaps just the chance of some chance variation in the sample? It is to answer this question that we perform hypothesis tests.

In order to perform a hypothesis test we first formulate a null hypothesis. Here that the difference in population means (`mu`) is equal to 0 using the `t.test` function.

```{r}
t.test(test_data_G$A170,test_data_GB$A170, mu=0)  # testing that mu = 0
```

How can we use this information to evaluate our initial null hypothesis. To judge this we need to know what random distribution the sample test statistic (**if the null hypothesis was true**). In this case this is a normal distribution. The p-value then then tells us how likely it is to get a result like the one we got (a difference of -0.76 or larger) if the null hypothesis was true (i.e. the true population means were the same). Here the p-value is smaller than 2.2e-16, i.e. extremely close and hence we can say that the difference is extremely unlikely to be due to chance variation and indeed Germans are a miserable lot.

What about the difference between the Great Britain and Sweden though?

```{r}
test_data_SW <- wb_data %>% 
  filter(S003 == "Sweden") %>%  # pick British data
  filter(S002EVS == "2008-2010")       # pick latest wave

mean_SW <- mean(test_data_SW$A170)

t.test(test_data_SW$A170,test_data_GB$A170, mu=0)  # testing that mu = 0

```

Here you can see that the p-value is 0.1251, hence the probability of getting a result like the one we got, a difference in means of about 0.15, if the true population means were equal, is about 12.5%. Is that small enough for us to declare that we do not believe in the null hypothesis? This isn't so obvious any more. There are actually some "conventions" in the sense that we often say that we reject the null hypothes if that p-value is smaller than either 0.1, 0.05 or 0.01. 

But we shouldn't just adopt such a convention without understanding what these values mean. In order to do so we will add another variable to our dataset, a truly random variable, but drawn from the same distribution for all individuals

```{r}
wb_data$rvar <- rnorm(nrow(wb_data))   # add random variable
```

We will now check whether the average value for that variable differs between countries. Of course we know that it shouldn't as all observations are draws from the same random variable, a standard normal random variable and hence the true population mean for all countries **is 0**.

But let's pretend we didn't know that.

```{r}
test_data <- wb_data %>% 
  filter(S002EVS == "2008-2010")       # pick latest wave

countries <- unique(test_data$S003)  # List of all countries
n_countries <- length(countries)   # Number of countries, 46
```

Now we will perform the above test for all possible combinations of countries and will record the respective p-value. Don't worry too much about this double `for` loop. 

```{r}
save_pvalue <- matrix(NA,n_countries,n_countries)

for (i in seq(2,n_countries)){
  for (j in seq(1,(i-1))){
    test_data_1 <- test_data %>% 
    filter(S003 == countries[i]) 
    mean_1 <- mean(test_data_1$A170)

    test_data_2 <- test_data %>% 
    filter(S003 == countries[j]) 
    mean_2 <- mean(test_data_2$A170)
    
    tt <- t.test(test_data_1$rvar,test_data_2$rvar, mu=0)  # testing that mu = 0
    save_pvalue[i,j] <- unlist(tt["p.value"])    # this will just pick the p-value
  }
}
```

This leaves us with (46*46-46)/2=1035 hypothesis tests. All of which of a null hypothesis which we know to be true (population means are identical). Let's see how many of these hypothesis tests delivered p-values which are smaller than 10%.

```{r}
tre <- (save_pvalue<0.1)   # value of TRUE if pvalue < 0.1

cols <- c("TRUE" = "#FFFFFF","FALSE" = "#66FF33")

# the names aren't necessary here.

image(1:nrow(tre), 1:ncol(tre), as.matrix(tre), col=cols)

table(tre)
```

The green blots on the graph indicate rejections of the null hypothesis. As you can see, `r table(tre)[2]` of the 1035 tests produced a test statistic with a p-value smaller than 10%. So for these we may be tempted to say that we reject the null hypothesis. So here we have arrived at the point where we can perhaps understand what it means to perform a hypothesis test. Even if the null hypothesis is correct (which in reality we will of course not know) we may actually reject the null hypothesis. We call this making a Type 1 error. Vice versa, if in truth the null hypothesis is incorrect we may come tothe conclusion not to reject the null hypothesis (this is what is called a Type 2 error).

As you can see here we have made a Type 1 error in about 10% of cases. This is no accident. If we had checked what percentage of these tests (remember for all the null hypothesis is true) had p-vaues < 5% we would have found approximately 5% of tests that had p-values smaller than 5%. In fact this is what a hypothesis test is designed to do. So this gives us now a clue of the role of this threshold against which we compare the p-value. 

You may wonder then why we do not use a threshold as small as possible, after all that would minimise the probability of making a Type 1 error. However, the flip side of reducing a TYpe 1 error is that we would at the same time increase the probability of making a Type 2 error, i.e. a failure to reject an incorrect null hypothesis.

Let's return to the Life Satisfaction data and repeat the above calculations.

```{r}
save_pvalue <- matrix(NA,n_countries,n_countries)

for (i in seq(2,n_countries)){
  for (j in seq(1,(i-1))){
    test_data_1 <- test_data %>% 
    filter(S003 == countries[i]) 
    mean_1 <- mean(test_data_1$A170)

    test_data_2 <- test_data %>% 
    filter(S003 == countries[j]) 
    mean_2 <- mean(test_data_2$A170)
    
    tt <- t.test(test_data_1$A170,test_data_2$A170, mu=0)  # testing that mu = 0
    save_pvalue[i,j] <- unlist(tt["p.value"])    # this will just pick the p-value
  }
}

tre <- (save_pvalue<0.1)   # value of TRUE if pvalue < 0.1

cols <- c("TRUE" = "#FFFFFF","FALSE" = "#66FF33")

# the names aren't necessary here.

image(1:nrow(tre), 1:ncol(tre), as.matrix(tre), col=cols)

table(tre)
```

As is obvious from the visualisation we have many more rejections about 90%. For each combination of countries for which we reject the null hypothesis we say that there is a statistically significant difference in average life satisfaction. However, that does not mean that these differences represent meaningful differences. This is an important difference to keep in mind.

# Regression Analysis

Hypothesis testing is a crucial tool of empirical analysis. Another tool we will use repeatedly is that of regresison analysis. In fact, sometimes, running a regression is a convenient way to deliver a hyothesis test. Let us demonstrate this with one of the above examples, the difference in average life satisfaction between Great Britain and Sweden.

Let's create a new dataset which only contains the Swedish and British data. 

```{r}
test_data <- wb_data %>% 
  filter(S003 %in% c("Sweden","Great Britain")) %>%  # pick British data
  filter(S002EVS == "2008-2010")         # pick latest wave
```

Then we run a regression with the Life Expectancy as the dependent variable and a constant and a dummy variable which takes the value 1 if the respondent is from Sweden and 0 if the repondent is from Britain. This is achieved by specifying the model as `A170~S003`. The variable name before the `~` 

```{r}
mod1 <- lm(A170~S003,data=test_data)
stargazer(mod1, type="text")
```

This regresison 